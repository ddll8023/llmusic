# LLMusic 本地音乐播放器 - 综合开发文档

## 1. 项目概述

一个基于 Electron 和 Vue.js 的桌面音乐播放器。应用的核心功能是扫描、管理和播放本地音频文件，提供一个美观、响应迅速的用户界面。

### 核心功能

- **多音乐库管理**: 支持添加、管理和切换多个独立的本地音乐库。
- **本地音乐管理**: 扫描并管理本地音乐库。
- **播放控制**: 提供完整的播放控制（播放/暂停、上一曲/下一曲）。
- **播放模式**: 支持多种播放模式（顺序、随机、单曲循环）。
- **播放次数统计**: 记录并显示每首歌曲的播放次数，并支持排序。
- **状态持久化**: 记忆播放列表和播放模式，重启应用后恢复上次播放状态。
- **界面优化**:
  - 可收缩侧边栏，优化界面空间利用。
  - 虚拟滚动技术，支持海量歌曲流畅列表。
  - 歌曲右键菜单，快速执行常用操作。
- **音频特性**:
  - 专辑封面显示。
  - 音量控制。
- **系统集成**:
  - 支持最小化到系统托盘，可在设置中选择关闭行为。

## 2. 技术栈

- **核心框架:** Electron (`^36.4.0`), Vue.js 3 (`^3.5.16`)
- **状态管理:** Pinia (`^3.0.3`)
- **UI 性能:** `vue-virtual-scroller` (用于处理大数据列表的虚拟滚动)
- **构建工具:** Vite (`^6.3.5`)
- **数据库:** `lowdb` (`^7.0.1`) (一个基于 JSON 文件的轻量级数据库)
- **音频元数据:** `music-metadata` (`^11.2.3`)
- **音频处理:** `ffmpeg-static` 和 `fluent-ffmpeg`
- **唯一 ID 生成:** `uuid` (`^11.1.0`)
- **样式:** CSS3
- **进程间通信:** Electron IPC

## 3. 项目结构

- **`src-main/`**: Electron 主进程代码
  - `main.js`: Electron 主入口
  - `database.js`: 使用 lowdb 的数据库模块
  - `musicScanner.js`: 音乐文件扫描模块
  - `preload.js`: 预加载脚本，暴露安全的 API
  - `ipc-handlers/`: 全新的 IPC 处理目录，按功能域拆分
    - `index.js`: 统一注册与卸载所有处理模块
    - `windowHandlers.js`: 窗口控制与剪贴板/文件位置
    - `scanHandlers.js`: 音乐扫描、取消与进度推送
    - `songHandlers.js`: 歌曲 / 歌词 / 封面 / 播放控制
    - `playlistHandlers.js`: 播放列表 CRUD
    - `libraryHandlers.js`: 音乐库 CRUD
  - `utils/`: 主进程通用工具
    - `throttle.js`: 通用节流函数
    - `lruCache.js`: 简易 LRU 缓存实现
    - `ipcWrapper.js`: IPC 注册封装，统一错误处理与可选节流
  - `constants/ipcChannels.js`: IPC 通道名称常量中心
  - `audioProcessor.js`: 音频处理服务，负责音频文件验证、转换和元数据提取
  - `audioPlayer.js`: 兼容层，提供向后兼容的 API，内部使用 audioProcessor
  - **歌词解析器 (`lyricsParser.js`)**: 负责解析 `.lrc` 歌词文件，提取时间轴与歌词文本。
- **`src-renderer/`**: Vue 渲染进程代码
  - `main.js`: Vue 应用入口
  - `App.vue`: 根组件
  - **`components/`**: Vue 组件
    - `SideBar.vue`: 左侧导航栏（支持收缩/展开），包含到本地音乐、设置、我的收藏（未实现）等功能的导航。
    - `MainContent.vue`: 中间主内容区
    - `PlayerBar.vue`: 底部播放器控制栏
    - `Icon.vue`: 图标组件
    - `Settings.vue`: 设置页面组件
  - **`store/`**: Pinia 状态管理
    - `media.js`: 管理音乐库
    - `player.js`: 管理播放器状态
    - `ui.js`: 管理 UI 状态（如侧边栏收缩）
  - **`assets/`**: 静态资源
    - `icons.js`: SVG 图标集合

## 5. 开发指南

### 5.1. 核心模块设计

#### **主进程 (Main Process)**

- **窗口管理 (`main.js`)**: 创建和管理 `BrowserWindow`，配置尺寸、标题等，并隐藏默认菜单栏。支持最小化到托盘功能。
- **数据库模块 (`database.js`)**: 使用 `lowdb` 初始化 JSON 数据库，提供歌曲数据的增删改查接口，**新增内存索引 Map（songById / songByPath）以提升查询性能**。
- **音乐扫描模块 (`musicScanner.js`)**: 递归扫描指定目录的音频文件，使用 `music-metadata` 解析元数据和封面，并将结果存入数据库。通过 IPC 向渲染进程报告进度。
- **IPC 接口 (`ipc-handlers/index.js`)**: 集中处理所有来自渲染进程的请求，如 `'scan-music-start'`, `'get-songs'`, `'get-song-cover/:songId'` 等。

#### **渲染进程 (Renderer Process)**

- **UI 布局 (Vue Components)**:
  - `App.vue`: 根组件，组织三大布局区域（侧边栏、主内容区、播放器栏）。
  - `MainContent.vue`: 使用虚拟滚动高效渲染歌曲列表，并包含定位、返回顶部等快捷按钮。
  - `PlayerBar.vue`: 底部播放器，管理播放控件。
- **状态管理 (Pinia)**:
  - `useMediaStore`: 存储音乐库列表。
  - `usePlayerStore`: 管理当前播放状态，包括当前歌曲、播放/暂停状态、进度、音量、播放模式等。支持通过 localStorage 持久化存储状态，在应用重启后自动恢复播放列表、播放模式和音量设置。
  - `useUiStore`: 管理 UI 状态，包括侧边栏显示/隐藏、歌词动画效果和窗口关闭行为等设置。
- **IPC 通信 (`preload.js`)**: 遵循 Electron 安全实践，安全地将主进程提供的 IPC 接口暴露给渲染进程 (e.g., `window.electronAPI.getSongs()`)。

### 5.2. 开发规范

- **Store Action 命名**:
  - 直接设置状态的 Actions 使用 `set<StateName>` 格式 (e.g., `setPlaying(true)`)。
  - 执行切换或复杂逻辑的 Actions 使用描述其行为的动词 (e.g., `togglePlay`, `playNext`)。
  - 这有助于在组件中调用 Actions 时，使意图更加清晰。
- **进程职责分离**:
  - **主进程**: 负责所有与 Node.js API、文件系统和数据库相关的操作。
  - **渲染进程**: 专注于 UI 渲染和用户交互，通过 `preload.js` 暴露的接口与主进程通信。

## 6. 开发路线图

### Phase 1: 核心功能 (已完成)

- [x] **环境搭建**: 完成项目初始化、依赖安装和构建配置。
- [x] **Electron 基础框架**: 成功创建和管理窗口，并加载 Vue 应用。
- [x] **主进程核心功能**:
  - [x] 数据库模块 (`lowdb`)
  - [x] 音乐扫描与元数据解析
- [x] **渲染进程 UI 与逻辑**:
  - [x] 三栏式 UI 布局
  - [x] Pinia 状态管理
  - [x] 虚拟滚动歌曲列表
  - [x] 播放器控制条
- [x] **功能联调**:
  - [x] 实现从列表点击播放
  - [x] "扫描/同步"功能
  - [x] UI 样式初步完善

### Phase 2: 功能增强 (进行中)

- [⚠️] **歌词显示**:
  - [x] 支持 `.lrc` 文件解析与滚动显示。
  - [x] 无歌词时提供占位或提示。
  - [x] 鼠标悬停在歌词行上时，在左侧显示对应时间和播放图标。
- [✅] **搜索功能**:
  - [x] 在本地音乐头部添加搜索框
  - [x] 实现基于歌曲名、歌手、专辑的实时筛选
  - [x] 采用防抖技术优化搜索性能
- [⚠️] **播放列表管理**:
  - [ ] 允许用户创建、命名和编辑多个播放列表。
  - [⚠️] 实现将歌曲添加到指定播放列表的功能。(仅实现了单一播放列表)
- [✅] **播放次数统计**: 记录每首歌曲的播放次数，并在歌曲列表中展示和排序。
- [ ] **歌曲信息展示**
- [ ] **音频可视化**
- [ ] **音频均衡器 (Audio Equalizer)**
- [ ] **Mini 播放器模式 (Mini Player Mode)**
- [ ] **元数据标签编辑器 (Tag Editor)**
- [ ] **我的收藏功能 (Favorites)**
- [ ] **封面图片获取 (Album Art Fetching)**
- [ ] **多音乐库管理 (Multiple Library Management)**
- [ ] 播放列表导入 / 导出（JSON 格式）
- [ ] 播放列表批量编辑（多选删除、拖拽排序）

### Phase 3: 体验优化与重构 (远期规划)

- [x] **自定义标题栏**:
  - [x] 使用 Electron 的无边框窗口功能
  - [x] 实现自定义标题栏，包含应用图标、标题和窗口控制按钮
  - [x] 支持拖拽窗口、最小化、最大化/还原和关闭功能
  - [x] 与应用整体界面风格一致
- [x] **歌词动画效果设置功能**:
  - [x] 在设置页面中添加歌词页面动画效果选项
  - [x] 支持两种动画效果：淡入淡出和上滑动画
  - [x] 用户设置会保存在 localStorage 中，下次打开应用时保持一致
- [x] **播放状态记忆化功能**:
  - [x] 记忆播放列表和播放模式，重启应用后恢复
  - [x] 保存音量和静音状态设置
  - [x] 恢复上一次播放的歌曲（不自动播放）
  - [x] 所有状态在发生变化时自动保存
- [x] **窗口关闭行为设置**:
  - [x] 在设置页面添加窗口关闭行为选项
  - [x] 支持两种行为：退出应用或最小化到托盘
  - [x] 最小化到托盘时显示托盘图标和菜单
  - [x] 点击托盘图标可恢复窗口
- [ ] **主题系统**
- [ ] **快捷键支持**
- [ ] **国际化 (i18n)**
- [ ] **性能与架构**:
  - [ ] **数据库升级**
  - [⚠️] **代码重构**:
    - [✅] 音频处理模块重构
    - [ ] 其他模块重构
- [ ] **打包与分发**
- [ ] **交互体验优化**
- [ ] 性能监控面板（FPS / 内存 / CPU）
- [ ] 自动更新机制
- [ ] 单元测试覆盖 (Mocha + Spectron)

## 7. 功能实现状态

### 功能实现状态详细表格

| 功能                        | 状态        | 说明                                                                                                                                                         |
| --------------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Phase 1: 核心功能**       | ✅ 已完成   | 所有核心功能均已实现                                                                                                                                         |
| **Phase 2: 功能增强**       | ⚠️ 部分完成 |                                                                                                                                                              |
| - 歌词显示                  | ✅ 已完成   | 支持 LRC 解析与滚动显示，无歌词时有提示，支持多种动画效果，悬停时显示时间和播放图标，支持字体大小调整和时间偏移调整(+/-0.5 秒)，支持点击歌词跳转到对应时间点 |
| - 搜索功能                  | ✅ 已完成   | 在本地音乐头部添加了搜索框，支持对歌名、歌手、专辑进行实时、防抖筛选，搜索结果立即显示                                                                       |
| - 播放列表管理              | ⚠️ 部分完成 | 仅实现单一播放列表，支持播放列表记忆功能，未实现多播放列表                                                                                                   |
| - 播放次数统计              | ✅ 已完成   | 歌曲播放完毕后自动记录播放次数，并在主列表视图中展示，支持按播放次数排序。                                                                                   |
| - 歌曲右键菜单              | ✅ 已完成   | 支持右键点击歌曲显示菜单，包含播放/暂停、添加到播放列表、显示歌词、查看信息、显示文件位置、复制信息、从列表中删除等功能                                      |
| - 歌曲信息展示              | ❌ 未实现   | 未实现歌曲详情页面                                                                                                                                           |
| - 我的收藏                  | ❌ 未实现   | UI 入口已添加在侧边栏，功能待实现                                                                                                                            |
| - 音频可视化                | ❌ 未实现   | 未实现音频频谱或波形图                                                                                                                                       |
| - 多音乐库管理              | ✅ 已完成   | 支持在设置页面添加、移除和重新扫描多个音乐库。支持在侧边栏切换不同的库视图以及"所有音乐"视图。                                                               |
| **Phase 3: 体验优化与重构** | ⚠️ 部分完成 | 已实现部分 UI 个性化设置和状态持久化                                                                                                                         |
| - 自定义标题栏              | ✅ 已完成   | 使用无边框窗口配合自定义组件实现，支持拖拽、最小化、最大化/还原、关闭功能，与应用整体风格一致                                                                |
| - 歌词动画效果设置功能      | ✅ 已完成   | 支持淡入淡出和上滑动画效果，设置保存在 localStorage，可在设置页面中切换                                                                                      |
| - 播放状态记忆化            | ✅ 已完成   | 记忆播放列表、播放模式、音量、当前歌曲等，重启应用后自动恢复，通过 localStorage 实现                                                                         |
| - 可收缩侧边栏              | ✅ 已完成   | 支持侧边栏展开/收缩切换，优化界面空间利用                                                                                                                    |
| - 虚拟滚动                  | ✅ 已完成   | 使用 vue-virtual-scroller 实现高效的大列表渲染，支持滚动到顶部和定位到当前播放歌曲                                                                           |
| - 窗口关闭行为设置          | ✅ 已完成   | 支持在设置中选择关闭窗口时的行为：退出应用或最小化到托盘，设置保存在 localStorage                                                                            |
| - 音频处理模块重构          | ✅ 已完成   | 重构了主进程中的音频处理模块，分离为核心处理模块和兼容层，优化了音频处理参数，增强了错误处理和文件格式验证                                                   |

## 本次修改内容

### `lyricsParser.js` 模块重构

**修改目的**:
本次修改的目的是对 `src-main/lyricsParser.js` 模块进行一次全面的重构和优化。旧版代码在性能、可读性和健壮性方面存在不足，特别是时间戳解析逻辑复杂且容易出错，导致歌词时间显示不正确。优化旨在提升代码质量，使其更高效、更易于维护，并修复关键的解析缺陷。

**修改内容**:

1.  **代码结构优化**: 将 `parseLrc` 函数的核心逻辑拆分，提高了代码的模块化和单一职责。
2.  **性能提升**: 优化了正则表达式的使用，避免了对单行文本的重复扫描，提升了解析效率。
3.  **健壮性增强**:
    - 为所有核心函数增加了严格的输入验证和边界条件检查。
    - 重写了时间戳解析逻辑，通过 `_parseTimestamp` 辅助函数确保只有有效的时间数据才会被处理，从根本上解决了时间显示为"0"和跳转不准的问题。
4.  **可读性与可维护性**:
    - 重构了 `findCurrentLyricIndex` 中的二分查找算法，使其更符合标准范式，易于理解。
    - 为所有公共接口和模块添加了完整的 JSDoc 注释，提升了代码的可文档性。

**功能影响**:

- 修复了 LRC 歌词时间戳解析可能失败的严重 bug。
- 提高了歌词解析的性能和对不规范格式的兼容性。
- 优化后的代码为未来新增功能（如更复杂的歌词格式支持）打下了坚实的基础。
